---
title: "Figure_3_Data_Analysis"
author: "Trevor Tivey"
date: "9/20/2021"
output: html_document
---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(dplyr)
library(data.table)
library(tidyr)
library(splitstackshape)
library(ggplot2)
library(rstatix)
library(ggpubr)
library(tidyverse)
library(nlme)
library(multcomp)
library(car)
library(emmeans)
library(lme4)

```

# Set appropriate breakpoints for cell cluster size discrimination

```{r breaks, include=FALSE, results=}

breaks1 = c(0.001, 0.2001, 0.4001, 0.5001, 0.6001, 0.7001, 0.8001, 1.001, 1.251, 1.401, 1.801, 2.001, 2.201, 2.301, 2.401, 2.601, 2.801, 3.001, 3.301)
breaks2 = seq(3.501,1000.001,0.5)
breaks3 = seq(3.501,999.501,0.5)
breaks = c(breaks1,breaks2)
breaks_names = c(breaks1,breaks3)
```

# Create cluster lists
```{r clusterlists, include=FALSE, results=}
# Set directory
setwd("./all-3dobj-counts/")

# List txt file outputs generated by ImageJ2 3D Object Counter

clusterlist = list.files(pattern = ".txt")

# Loop through files to select sample name, object area, cut sizes according to breaks, and write output to new file.


## note, reading tab separated txt files as csv input.
## e.g. sample_file <-read.csv("Movie-11-Image Export-443merge.txt", header = T, sep = "\t")

for(i in 1:length(clusterlist)) {
  sample_file <- read.csv(clusterlist[i], header = T, sep = "\t")
  sample_name = clusterlist[i]
  if(nrow(sample_file) > 1) {
    sample_file$X.1 <- seq.int(nrow(sample_file))
    sample_file2 <- sample_file %>% dplyr::select(2, 26)
    sample_file2$clustersize <- sample_file2$Surface..pixel.2./100
    sample_file2$name <- sample_name
    
    print(sample_file2)
    
    clustersize.cut = cut(sample_file2$clustersize, breaks, right=FALSE)

    clustertable <- table(clustersize.cut)
    clusterdf <- data.frame(clustertable)

    
    clusterdft <- t(clusterdf)
    clust_size <- breaks_names
    colnames(clusterdft) <- clust_size
    
    sample_image <- c(sample_name,sample_name)
    
    sample_file_clust_hist <- cbind(sample_image,clusterdft)
    
    setwd("../output-3dobj-counts-with-zeros/")
    write.csv(sample_file2, clusterlist[i])
    setwd("../output-hists-with-zeros/")
    write.csv(sample_file_clust_hist, clusterlist[i])
    setwd("../all-3dobj-counts/")

  }
  # If input file has no objects, placeholder file created.
  else {
    X.1 <- c(1)
    Surface..pixel.2. <- c(0)
    clustersize <- c(0)
    name <- c(sample_name)
    sample_file2 <- data.frame(X.1,Surface..pixel.2.,clustersize,name)
    
    print(sample_file2)
    
    clustersize.cut = cut(sample_file2$clustersize, breaks, right=FALSE)
    #print(clustersize.cut)
    clustertable <- table(clustersize.cut)
    clusterdf <- data.frame(clustertable)
    # print(clusterdf)
    
    clusterdft <- t(clusterdf)
    clust_size <- breaks_names
    colnames(clusterdft) <- clust_size
    
    sample_image <- c(sample_name,sample_name)
    
    sample_file_clust_hist <- cbind(sample_image,clusterdft)

    
    setwd("../output-3dobj-counts-with-zeros/")
    write.csv(sample_file2, clusterlist[i])
    setwd("../output-hists-with-zeros/")
    write.csv(sample_file_clust_hist, clusterlist[i])
    setwd("../all-3dobj-counts/")
    
  }
}

```
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
# Double-check break names is same as cluster tables
```{r}
length(breaks_names)
length(clustertable)
```

# Summarize into summary files with and without including zeros
```{r}

setwd("./output-3dobj-counts-with-zeros/")
objcount_w_zeros.list = list.files(pattern = ".txt")
ocount_w_zeros.1 = lapply(objcount_w_zeros.list, read.csv, header=T, stringsAsFactors = F)
ocount_w_zeros.2 <- rbindlist(ocount_w_zeros.1, fill = T)


setwd("../output-hists-with-zeros/")
hist_w_zeros.list = list.files(pattern = ".txt")
hist_w_zeros.1 = lapply(hist_w_zeros.list, read.csv, header=T, stringsAsFactors = F)
hist_w_zeros.2 <- rbindlist(hist_w_zeros.1, fill = T)
hist_w_zeros.3 <- subset(hist_w_zeros.2, X == "Freq")
colnames(hist_w_zeros.3) <- substring(colnames(hist_w_zeros.3), 2)
colnames(hist_w_zeros.3)[1] <- "category"
colnames(hist_w_zeros.3)[2] <- "sample_name"
```

# Write summary files
```{r}
numeric_column_id = 3:2014 # column ids to change to numeric
hist_w_zeros.4 <- dplyr::mutate_each(hist_w_zeros.3, funs(as.numeric), numeric_column_id)
hist_w_zeros.4$greater_than_50 <- rowSums(hist_w_zeros.4[,116:1003])
hist_w_zeros.5 <- hist_w_zeros.4[,2:115]
hist_w_zeros.6 <- cbind(hist_w_zeros.5,hist_w_zeros.4$greater_than_50)

setwd("./summary csv/")

write.csv(hist_w_zeros.4, "hist-0-long.csv")
write.csv(hist_w_zeros.6, "hist-0-short.csv")

write.csv(ocount_w_zeros.2, "obj_count_combined_w0.csv")
```



# Summarize obj_count_combined to get total cluster number, total cluster volume, total cluster size, by name
```{r}
setwd("./summary csv/")

### link both csvs

clusts_one <- read.csv("onestrainclusteranalysis.csv", header = T)

clusts_plus_one <- clusts_one

# grouping cluster groups based on corresponding hand count data
clusts_plus_one <- clusts_plus_one %>%
    mutate(Xone = dplyr::select(., X0.001:X0.4001) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(Xtwo = dplyr::select(., X0.5001:X1.001) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(Xthree = dplyr::select(., X1.251:X1.801) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(Xfour = dplyr::select(., X2.001:X2.801) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(Xfive = dplyr::select(., X3.001:X3.301) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X6to9 = dplyr::select(., X3.501:X5.001) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X10to15 = dplyr::select(., X5.501:X8.001) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X15to50 = dplyr::select(., X8.501:X25.001) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(Xover50 = dplyr::select(., X25.501:X999.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(Xover15 = dplyr::select(., X8.501:X999.501) %>% rowSums(na.rm = TRUE))
```
# Melt data frame to long form
```{r}

clusts_plus_long_one <- reshape2::melt(clusts_plus_one,
        # ID variables - all the variables to keep but not split apart on
    id.vars=c(1:24),
        # The source columns
        # Name of the destination column that will identify the original
        # column that the measurement came from
    variable.name="cluster_type",
    value.name="frequency"
)

#clusts_plus_long_one <- clusts_plus_long_one %>% unite("anemoneuniqueclust", anemoneunique, #cluster_type, sep = ".", remove = FALSE)

```


# Subset by temperature treatment
```{r}
clusts_26_one <- subset(clusts_plus_long_one, Treatment == "26")
clusts_26_one <- subset(clusts_26_one, (cluster_type %in% c("Xone","Xtwo","Xthree","Xfour","Xfive", "X6to9","X10to15","Xover15","Xover50")))

clusts_32_one <- subset(clusts_plus_long_one, Treatment == "32")
clusts_32_one <- subset(clusts_32_one, (cluster_type %in% c("Xone","Xtwo","Xthree","Xfour","Xfive","X6to9","X10to15","Xover15","Xover50")))

```

# Counting total clusters
```{r}
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_50_100 = dplyr::select(., X25.501:X50.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_100_200 = dplyr::select(., X51.001:X100.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_200_300 = dplyr::select(., X101.001:X150.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_300_400 = dplyr::select(., X151.001:X200.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_400_500 = dplyr::select(., X201.001:X250.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_500_600 = dplyr::select(., X251.001:X300.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_600_700 = dplyr::select(., X301.001:X350.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_700_800 = dplyr::select(., X351.001:X400.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_800_900 = dplyr::select(., X401.001:X450.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_900_1000 = dplyr::select(., X451.001:X500.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_1000_1100 = dplyr::select(., X501.001:X550.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_1100_1200 = dplyr::select(., X551.001:X600.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_1200_1300 = dplyr::select(., X601.001:X650.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_1300_1400 = dplyr::select(., X651.001:X700.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_1400_1500 = dplyr::select(., X701.001:X750.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_1500_1600 = dplyr::select(., X751.001:X800.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_1600_1700 = dplyr::select(., X801.001:X850.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_1700_1800 = dplyr::select(., X851.001:X900.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_1800_1900 = dplyr::select(., X901.001:X950.501) %>% rowSums(na.rm = TRUE))
clusts_plus_one <- clusts_plus_one %>%
    mutate(X_1900_2000 = dplyr::select(., X951.001:X999.501) %>% rowSums(na.rm = TRUE))
```

# Counting total cells
```{r}
clusts_plus_one$hist_sum_one <- clusts_plus_one$Xone
clusts_plus_one$hist_sum_two <- 2*clusts_plus_one$Xtwo
clusts_plus_one$hist_sum_three <- 3*clusts_plus_one$Xthree
clusts_plus_one$hist_sum_four <- 4*clusts_plus_one$Xfour
clusts_plus_one$hist_sum_five <- 5*clusts_plus_one$Xfive
clusts_plus_one$hist_sum_6to9 <- 6*clusts_plus_one$X3.501 +
  7*clusts_plus_one$X4.001 +
  8*clusts_plus_one$X4.501 +
  9*clusts_plus_one$X5.001
clusts_plus_one$hist_sum_10to15 <- 10*clusts_plus_one$X5.501 +
  11*clusts_plus_one$X6.001 +
  12*clusts_plus_one$X6.501 +
  13*clusts_plus_one$X7.001 +
  14*clusts_plus_one$X7.501 +
  15*clusts_plus_one$X8.001
clusts_plus_one$hist_sum_15to50 <- 16*clusts_plus_one$X8.501 +
  17*clusts_plus_one$X9.001 +
  18*clusts_plus_one$X9.501 +
  19*clusts_plus_one$X10.001 +
  20*clusts_plus_one$X10.501 +
  21*clusts_plus_one$X11.001 +
  22*clusts_plus_one$X11.501 +
  23*clusts_plus_one$X12.001 +
  24*clusts_plus_one$X12.501 +
  25*clusts_plus_one$X13.001 +
  26*clusts_plus_one$X13.501 +
  27*clusts_plus_one$X14.001 +
  28*clusts_plus_one$X14.501 +
  29*clusts_plus_one$X15.001 +
  30*clusts_plus_one$X15.501 +
  31*clusts_plus_one$X16.001 +
  32*clusts_plus_one$X16.501 +
  33*clusts_plus_one$X17.001 +
  34*clusts_plus_one$X17.501 +
  35*clusts_plus_one$X18.001 +
  36*clusts_plus_one$X18.501 +
  37*clusts_plus_one$X19.001 +
  38*clusts_plus_one$X19.501 +
  39*clusts_plus_one$X20.001 +
  40*clusts_plus_one$X20.501 +
  41*clusts_plus_one$X21.001 +
  42*clusts_plus_one$X21.501 +
  43*clusts_plus_one$X22.001 +
  44*clusts_plus_one$X22.501 +
  45*clusts_plus_one$X23.001 +
  46*clusts_plus_one$X23.501 +
  47*clusts_plus_one$X24.001 +
  48*clusts_plus_one$X24.501 +
  49*clusts_plus_one$X25.001 
clusts_plus_one$hist_sum_over50 <- 75*clusts_plus_one$X_50_100 +
  150*clusts_plus_one$X_100_200 +
  250*clusts_plus_one$X_200_300 +
  350*clusts_plus_one$X_300_400 +
  450*clusts_plus_one$X_400_500 +
  550*clusts_plus_one$X_500_600 +
  650*clusts_plus_one$X_600_700 +
  750*clusts_plus_one$X_700_800 +
  850*clusts_plus_one$X_800_900 +
  950*clusts_plus_one$X_900_1000 +
  1050*clusts_plus_one$X_1000_1100 +
  1150*clusts_plus_one$X_1100_1200 +
  1250*clusts_plus_one$X_1200_1300 +
  1350*clusts_plus_one$X_1300_1400 +
  1450*clusts_plus_one$X_1400_1500 +
  1550*clusts_plus_one$X_1500_1600 +
  1650*clusts_plus_one$X_1600_1700 +
  1750*clusts_plus_one$X_1700_1800 +
  1850*clusts_plus_one$X_1800_1900 +
  1950*clusts_plus_one$X_1900_2000



clusts_plus_one$hist_sum_over15 <- 16*clusts_plus_one$X8.501 +
  17*clusts_plus_one$X9.001 +
  18*clusts_plus_one$X9.501 +
  19*clusts_plus_one$X10.001 +
  20*clusts_plus_one$X10.501 +
  21*clusts_plus_one$X11.001 +
  22*clusts_plus_one$X11.501 +
  23*clusts_plus_one$X12.001 +
  24*clusts_plus_one$X12.501 +
  25*clusts_plus_one$X13.001 +
  26*clusts_plus_one$X13.501 +
  27*clusts_plus_one$X14.001 +
  28*clusts_plus_one$X14.501 +
  29*clusts_plus_one$X15.001 +
  30*clusts_plus_one$X15.501 +
  31*clusts_plus_one$X16.001 +
  32*clusts_plus_one$X16.501 +
  33*clusts_plus_one$X17.001 +
  34*clusts_plus_one$X17.501 +
  35*clusts_plus_one$X18.001 +
  36*clusts_plus_one$X18.501 +
  37*clusts_plus_one$X19.001 +
  38*clusts_plus_one$X19.501 +
  39*clusts_plus_one$X20.001 +
  40*clusts_plus_one$X20.501 +
  41*clusts_plus_one$X21.001 +
  42*clusts_plus_one$X21.501 +
  43*clusts_plus_one$X22.001 +
  44*clusts_plus_one$X22.501 +
  45*clusts_plus_one$X23.001 +
  46*clusts_plus_one$X23.501 +
  47*clusts_plus_one$X24.001 +
  48*clusts_plus_one$X24.501 +
  49*clusts_plus_one$X25.001 +
  75*clusts_plus_one$X_50_100 +
  150*clusts_plus_one$X_100_200 +
  250*clusts_plus_one$X_200_300 +
  350*clusts_plus_one$X_300_400 +
  450*clusts_plus_one$X_400_500 +
  550*clusts_plus_one$X_500_600 +
  650*clusts_plus_one$X_600_700 +
  750*clusts_plus_one$X_700_800 +
  850*clusts_plus_one$X_800_900 +
  950*clusts_plus_one$X_900_1000 +
  1050*clusts_plus_one$X_1000_1100 +
  1150*clusts_plus_one$X_1100_1200 +
  1250*clusts_plus_one$X_1200_1300 +
  1350*clusts_plus_one$X_1300_1400 +
  1450*clusts_plus_one$X_1400_1500 +
  1550*clusts_plus_one$X_1500_1600 +
  1650*clusts_plus_one$X_1600_1700 +
  1750*clusts_plus_one$X_1700_1800 +
  1850*clusts_plus_one$X_1800_1900 +
  1950*clusts_plus_one$X_1900_2000




clusts_plus_one$hist_sum <- 
  clusts_plus_one$Xone + 
  2*clusts_plus_one$Xtwo +
  3*clusts_plus_one$Xthree + 
  4*clusts_plus_one$Xfour +
  5*clusts_plus_one$Xfive +
  6*clusts_plus_one$X3.501 +
  7*clusts_plus_one$X4.001 +
  8*clusts_plus_one$X4.501 +
  9*clusts_plus_one$X5.001 +
  10*clusts_plus_one$X5.501 +
  11*clusts_plus_one$X6.001 +
  12*clusts_plus_one$X6.501 +
  13*clusts_plus_one$X7.001 +
  14*clusts_plus_one$X7.501 +
  15*clusts_plus_one$X8.001 +
  16*clusts_plus_one$X8.501 +
  17*clusts_plus_one$X9.001 +
  18*clusts_plus_one$X9.501 +
  19*clusts_plus_one$X10.001 +
  20*clusts_plus_one$X10.501 +
  21*clusts_plus_one$X11.001 +
  22*clusts_plus_one$X11.501 +
  23*clusts_plus_one$X12.001 +
  24*clusts_plus_one$X12.501 +
  25*clusts_plus_one$X13.001 +
  26*clusts_plus_one$X13.501 +
  27*clusts_plus_one$X14.001 +
  28*clusts_plus_one$X14.501 +
  29*clusts_plus_one$X15.001 +
  30*clusts_plus_one$X15.501 +
  31*clusts_plus_one$X16.001 +
  32*clusts_plus_one$X16.501 +
  33*clusts_plus_one$X17.001 +
  34*clusts_plus_one$X17.501 +
  35*clusts_plus_one$X18.001 +
  36*clusts_plus_one$X18.501 +
  37*clusts_plus_one$X19.001 +
  38*clusts_plus_one$X19.501 +
  39*clusts_plus_one$X20.001 +
  40*clusts_plus_one$X20.501 +
  41*clusts_plus_one$X21.001 +
  42*clusts_plus_one$X21.501 +
  43*clusts_plus_one$X22.001 +
  44*clusts_plus_one$X22.501 +
  45*clusts_plus_one$X23.001 +
  46*clusts_plus_one$X23.501 +
  47*clusts_plus_one$X24.001 +
  48*clusts_plus_one$X24.501 +
  49*clusts_plus_one$X25.001 +
  75*clusts_plus_one$X_50_100 +
  150*clusts_plus_one$X_100_200 +
  250*clusts_plus_one$X_200_300 +
  350*clusts_plus_one$X_300_400 +
  450*clusts_plus_one$X_400_500 +
  550*clusts_plus_one$X_500_600 +
  650*clusts_plus_one$X_600_700 +
  750*clusts_plus_one$X_700_800 +
  850*clusts_plus_one$X_800_900 +
  950*clusts_plus_one$X_900_1000 +
  1050*clusts_plus_one$X_1000_1100 +
  1150*clusts_plus_one$X_1100_1200 +
  1250*clusts_plus_one$X_1200_1300 +
  1350*clusts_plus_one$X_1300_1400 +
  1450*clusts_plus_one$X_1400_1500 +
  1550*clusts_plus_one$X_1500_1600 +
  1650*clusts_plus_one$X_1600_1700 +
  1750*clusts_plus_one$X_1700_1800 +
  1850*clusts_plus_one$X_1800_1900 +
  1950*clusts_plus_one$X_1900_2000

```

# Total cluster count
```{r}
clusts_plus_one$hist_count <- 
  clusts_plus_one$Xone + 
  clusts_plus_one$Xtwo +
  clusts_plus_one$Xthree + 
  clusts_plus_one$Xfour +
  clusts_plus_one$Xfive +
  clusts_plus_one$X3.501 +
  clusts_plus_one$X4.001 +
  clusts_plus_one$X4.501 +
  clusts_plus_one$X5.001 +
  clusts_plus_one$X5.501 +
  clusts_plus_one$X6.001 +
  clusts_plus_one$X6.501 +
  clusts_plus_one$X7.001 +
  clusts_plus_one$X7.501 +
  clusts_plus_one$X8.001 +
  clusts_plus_one$X8.501 +
  clusts_plus_one$X9.001 +
  clusts_plus_one$X9.501 +
  clusts_plus_one$X10.001 +
  clusts_plus_one$X10.501 +
  clusts_plus_one$X11.001 +
  clusts_plus_one$X11.501 +
  clusts_plus_one$X12.001 +
  clusts_plus_one$X12.501 +
  clusts_plus_one$X13.001 +
  clusts_plus_one$X13.501 +
  clusts_plus_one$X14.001 +
  clusts_plus_one$X14.501 +
  clusts_plus_one$X15.001 +
  clusts_plus_one$X15.501 +
  clusts_plus_one$X16.001 +
  clusts_plus_one$X16.501 +
  clusts_plus_one$X17.001 +
  clusts_plus_one$X17.501 +
  clusts_plus_one$X18.001 +
  clusts_plus_one$X18.501 +
  clusts_plus_one$X19.001 +
  clusts_plus_one$X19.501 +
  clusts_plus_one$X20.001 +
  clusts_plus_one$X20.501 +
  clusts_plus_one$X21.001 +
  clusts_plus_one$X21.501 +
  clusts_plus_one$X22.001 +
  clusts_plus_one$X22.501 +
  clusts_plus_one$X23.001 +
  clusts_plus_one$X23.501 +
  clusts_plus_one$X24.001 +
  clusts_plus_one$X24.501 +
  clusts_plus_one$X25.001 +
  clusts_plus_one$X_50_100 +
  clusts_plus_one$X_100_200 +
  clusts_plus_one$X_200_300 +
  clusts_plus_one$X_300_400 +
  clusts_plus_one$X_400_500 +
  clusts_plus_one$X_500_600 +
  clusts_plus_one$X_600_700 +
  clusts_plus_one$X_700_800 +
  clusts_plus_one$X_800_900 +
  clusts_plus_one$X_900_1000 +
  clusts_plus_one$X_1000_1100 +
  clusts_plus_one$X_1100_1200 +
  clusts_plus_one$X_1200_1300 +
  clusts_plus_one$X_1300_1400 +
  clusts_plus_one$X_1400_1500 +
  clusts_plus_one$X_1500_1600 +
  clusts_plus_one$X_1600_1700 +
  clusts_plus_one$X_1700_1800 +
  clusts_plus_one$X_1800_1900 +
  clusts_plus_one$X_1900_2000
```

# Total cluster count under 15
```{r}
clusts_plus_one$hist_count_15 <- 
  clusts_plus_one$Xone + 
  2*clusts_plus_one$Xtwo +
  3*clusts_plus_one$Xthree + 
  4*clusts_plus_one$Xfour +
  5*clusts_plus_one$Xfive +
  6*clusts_plus_one$X3.501 +
  7*clusts_plus_one$X4.001 +
  8*clusts_plus_one$X4.501 +
  9*clusts_plus_one$X5.001 +
  10*clusts_plus_one$X5.501 +
  11*clusts_plus_one$X6.001 +
  12*clusts_plus_one$X6.501 +
  13*clusts_plus_one$X7.001 +
  14*clusts_plus_one$X7.501 +
  15*clusts_plus_one$X8.001
```


# 
```{r}

clusts_plus_long_one <- reshape2::melt(clusts_plus_one,
        # ID variables - all the variables to keep but not split apart on
    id.vars=c(1:24),
        # The source columns
        # Name of the destination column that will identify the original
        # column that the measurement came from
    variable.name="cluster_type",
    value.name="frequency"
)

```



```{r}
clusts_26_one <- subset(clusts_plus_long_one, Treatment == "26")
clusts_26_one <- subset(clusts_26_one, (cluster_type %in% c("Xone","Xtwo","Xthree","Xfour","Xfive", "X6to9","X10to15","Xover15")))

clusts_32_one <- subset(clusts_plus_long_one, Treatment == "32")
clusts_32_one <- subset(clusts_32_one, (cluster_type %in% c("Xone","Xtwo","Xthree","Xfour","Xfive","X6to9","X10to15","Xover15")))


clusts_26_hist <- subset(clusts_plus_long_one, Treatment == "26")
clusts_26_hist <- subset(clusts_26_hist, (cluster_type %in% c("hist_sum_one","hist_sum_two","hist_sum_three","hist_sum_four", "hist_sum_five","hist_sum_6to9","hist_sum_10to15","hist_sum_over15")))

clusts_32_hist <- subset(clusts_plus_long_one, Treatment == "32")
clusts_32_hist <- subset(clusts_32_hist, (cluster_type %in% c("hist_sum_one","hist_sum_two","hist_sum_three","hist_sum_four", "hist_sum_five","hist_sum_6to9","hist_sum_10to15","hist_sum_over15")))

```


```{r}


clusts_plus_one$Treatmentfactor <- as.factor(clusts_plus_one$Treatment)
clusts_plus_one_plot <- subset(clusts_plus_one, day != "NA")

```

# Visualization

```{r}
plot_cells_v_clusters <- ggplot(clusts_plus_one_plot,aes(x=numberofclusters.1,y=clustersize,color=Treatmentfactor)) +  geom_point()

plot_cells_v_clusters

plot_cells_v_clusters_day <- ggplot(clusts_plus_one_plot,aes(x=numberofclusters.1,y=clustersize,fill=Treatmentfactor, shape=Treatmentfactor)) +  geom_point() +facet_wrap(~day, nrow=1) +
  theme_linedraw() + 
  scale_shape_manual(values = c(21,22), name = "Treatment", labels = c("26","32")) +
  scale_fill_manual(values = c("darkorange","white"), name = "Treatment", labels = c("26","32")) +
  theme(legend.position="bottom") + guides(fill = guide_legend(nrow=1, byrow=TRUE)) + xlab("\n # of clusters per sample (days post-inoculation)") + ylab("# of cells per sample")

plot_cells_v_clusters_day
```

```{r}
plot_cells_v_clusters_day_final <-
plot_cells_v_clusters_day + theme(strip.background = element_rect(
     color="black", fill="grey", linetype="solid"), strip.text.x = element_text(color = "black"))
plot_cells_v_clusters_day_final

```

## Statistics



```{r}

#clusts_plus_one$hist_sum

clusts_plus_one_plot$sqhist <- (clusts_plus_one_plot$hist_sum)^(1/1)
histsum.mf <- lmer(sqhist ~ int + (1 | Plate), data = clusts_plus_one_plot)
summary(histsum.mf)

#assess normality
histsum.mfres = residuals(histsum.mf)
summary(histsum.mfres)
qqPlot(histsum.mfres)
hist(histsum.mfres)
boxplot(histsum.mfres)
shapiro.test(histsum.mfres)

#assess homoscedasticity
plot(fitted(histsum.mf),histsum.mfres);
abline(h=0,lty=2);
lines(smooth.spline(fitted(histsum.mf),histsum.mfres));


Anova(histsum.mf,test.statistic = 'F')

summary(glht(histsum.mf, linfct=mcp(int ="Tukey")))
```

```{r}

#clusts_plus_one$hist_count
clusts_plus_one_plot$sqhist <- (clusts_plus_one_plot$hist_count)^(1/2)
histcount.mf <- lmer(sqhist ~ int + (1 | Plate), data = clusts_plus_one_plot)
summary(histcount.mf)

#assess normality
histcount.mfres = residuals(histcount.mf)
summary(histcount.mfres)
qqPlot(histcount.mfres)
hist(histcount.mfres)
boxplot(histcount.mfres)
shapiro.test(histcount.mfres)

#assess homoscedasticity
plot(fitted(histcount.mf),histcount.mfres);
abline(h=0,lty=2);
lines(smooth.spline(fitted(histcount.mf),histcount.mfres));

Anova(histcount.mf,test.statistic = 'F')

summary(glht(histcount.mf, linfct=mcp(int ="Tukey")))
```

```{r}

clusts_plus_one_plot %>% 
    group_by(int) %>% 
    summarise(mean_hist_count = mean(hist_count))
clusts_plus_one_plot %>% 
    group_by(int) %>% 
    summarise(mean_hist_sum = mean(hist_sum))
```
# plot data transformations
```{r}
#plot average xone per day
qplot(data = clusts_plus_one_plot, y = Xone, x = day, group = Treatmentfactor, color = Treatmentfactor)

qplot(data = clusts_plus_one_plot, y = log(Xone), x = day, group = Treatmentfactor, color = Treatmentfactor)


qplot(data = clusts_plus_one_plot, y = sqrt(Xone), x = day, group = Treatmentfactor, color = Treatmentfactor)

qplot(data = clusts_plus_one_plot, y = (Xone)^(1/4), x = day, group = Treatmentfactor, color = Treatmentfactor)
```

# interaction
```{r}
clusts_plus_one_plot$int <- interaction(clusts_plus_one_plot$Treatmentfactor, clusts_plus_one_plot$day)
```

# 1
```{r}
clusts_plus_one_plot$sqone <- (clusts_plus_one_plot$Xone)^(1/4)

mod.mf <- lmer(sqone ~ int + (1 | Plate), data = clusts_plus_one_plot)
summary(mod.mf)
#vif(onelm)
#assess normality
mf.res = residuals(mod.mf)
summary(mf.res)
qqPlot(mf.res)
hist(mf.res)
boxplot(mf.res)
shapiro.test(mf.res)
#some of the points at the end do fall out of the 95% confidence interval, but it isn't too many. the majority fall withing the bounds

#assess homoscedasticity
plot(fitted(mod.mf),mf.res);
abline(h=0,lty=2);
lines(smooth.spline(fitted(mod.mf),mf.res));

Anova(mod.mf,test.statistic = 'F')

summary(glht(mod.mf, linfct=mcp(int ="Tukey")))
```

# 2
```{r}
clusts_plus_one_plot$sqtwo <- (clusts_plus_one_plot$Xtwo)^(1/4)

mod.mf2 <- lmer(sqtwo ~ int + (1 | Plate), data = clusts_plus_one_plot)
summary(mod.mf2)
#vif(onelm)
#assess normality
mf.res2 = residuals(mod.mf2)
summary(mf.res2)
qqPlot(mf.res2)
hist(mf.res2)
boxplot(mf.res2)
shapiro.test(mf.res2)

#assess homoscedasticity
plot(fitted(mod.mf2),mf.res2);
abline(h=0,lty=2);
lines(smooth.spline(fitted(mod.mf2),mf.res2));


summary(glht(mod.mf2, linfct=mcp(int ="Tukey")))
```

# 3
```{r}
clusts_plus_one_plot$sqthree <- (clusts_plus_one_plot$Xthree)^(1/2)

mod.mf3 <- lmer(sqthree ~ int + (1 | Plate), data = clusts_plus_one_plot)
summary(mod.mf3)

#assess normality
mf.res3 = residuals(mod.mf3)
summary(mf.res3)
qqPlot(mf.res3)
hist(mf.res3)
boxplot(mf.res3)
shapiro.test(mf.res3)

#assess homoscedasticity
plot(fitted(mod.mf3),mf.res3);
abline(h=0,lty=2);
lines(smooth.spline(fitted(mod.mf3),mf.res3));

summary(glht(mod.mf3, linfct=mcp(int ="Tukey")))
```

# 4
```{r}
clusts_plus_one_plot$sqfour <- (clusts_plus_one_plot$Xfour)^(1/2)

mod.mf4 <- lmer(sqfour ~ int + (1 | Plate), data = clusts_plus_one_plot)
summary(mod.mf4)

#assess normality
mf.res4 = residuals(mod.mf4)
summary(mf.res4)
qqPlot(mf.res4)
hist(mf.res4)
boxplot(mf.res4)
shapiro.test(mf.res4)

#assess homoscedasticity
plot(fitted(mod.mf4),mf.res4);
abline(h=0,lty=2);
lines(smooth.spline(fitted(mod.mf4),mf.res4));

summary(glht(mod.mf4, linfct=mcp(int ="Tukey")))
```

# 5
```{r}
clusts_plus_one_plot$sqfive <- (clusts_plus_one_plot$Xfive)^(1/2)

mod.mf5 <- lmer(sqfive ~ int + (1 | Plate), data = clusts_plus_one_plot)
summary(mod.mf5)

#assess normality
mf.res5 = residuals(mod.mf5)
summary(mf.res5)
qqPlot(mf.res5)
hist(mf.res5)
boxplot(mf.res5)
shapiro.test(mf.res5)

#assess homoscedasticity
plot(fitted(mod.mf5),mf.res5);
abline(h=0,lty=2);
lines(smooth.spline(fitted(mod.mf5),mf.res5));

summary(glht(mod.mf5, linfct=mcp(int ="Tukey")))
```

# 6-9
```{r}
clusts_plus_one_plot$sqsix <- (clusts_plus_one_plot$X6to9)^(1/2)

mod.mf6 <- lmer(sqsix ~ int + (1 | Plate), data = clusts_plus_one_plot)
summary(mod.mf6)

#assess normality
mf.res6 = residuals(mod.mf6)
summary(mf.res6)
qqPlot(mf.res6)
hist(mf.res6)
boxplot(mf.res6)
shapiro.test(mf.res6)

#assess homoscedasticity
plot(fitted(mod.mf6),mf.res6);
abline(h=0,lty=2);
lines(smooth.spline(fitted(mod.mf6),mf.res6));

summary(glht(mod.mf6, linfct=mcp(int ="Tukey")))
```

# 10-15
```{r}
clusts_plus_one_plot$sqten <- (clusts_plus_one_plot$X10to15)^(1/2)

mod.mf10 <- lmer(sqten ~ int + (1 | Plate), data = clusts_plus_one_plot)
summary(mod.mf10)

#assess normality
mf.res10 = residuals(mod.mf10)
summary(mf.res10)
qqPlot(mf.res10)
hist(mf.res10)
boxplot(mf.res10)
shapiro.test(mf.res10)

#assess homoscedasticity
plot(fitted(mod.mf10),mf.res10);
abline(h=0,lty=2);
lines(smooth.spline(fitted(mod.mf10),mf.res10));

summary(glht(mod.mf10, linfct=mcp(int ="Tukey")))
```

# over 15
```{r}
clusts_plus_one_plot$sq15 <- (clusts_plus_one_plot$Xover15)^(1/2)

mod.mf15 <- lmer(sq15 ~ int + (1 | Plate), data = clusts_plus_one_plot)
summary(mod.mf15)

#assess normality
mf.res15 = residuals(mod.mf15)
summary(mf.res15)
qqPlot(mf.res15)
hist(mf.res15)
boxplot(mf.res15)
shapiro.test(mf.res15)

#assess homoscedasticity
plot(fitted(mod.mf15),mf.res15);
abline(h=0,lty=2);
lines(smooth.spline(fitted(mod.mf15),mf.res15));

summary(glht(mod.mf15, linfct=mcp(int ="Tukey")))
```

# 50
```{r}
clusts_plus_one_plot$sq50 <- (clusts_plus_one_plot$Xover50)^(1/2)

mod.mf50 <- lmer(sq50 ~ int + (1 | Plate), data = clusts_plus_one_plot)
summary(mod.mf50)

#assess normality
mf.res50 = residuals(mod.mf50)
summary(mf.res50)
qqPlot(mf.res50)
hist(mf.res50)
boxplot(mf.res50)
shapiro.test(mf.res50)

#assess homoscedasticity
plot(fitted(mod.mf50),mf.res50);
abline(h=0,lty=2);
lines(smooth.spline(fitted(mod.mf50),mf.res50));

summary(glht(mod.mf50, linfct=mcp(int ="Tukey")))
```

# Plots

# Figure 3A

```{r}
total_mf_plot_26_32 <- ggplot(clusts_32_one,aes(x=day,y=-frequency,fill=cluster_type)) + 
 
  stat_summary(fun.data=mean_se,position=position_dodge(2.5),geom="errorbar",color = "black", width=2) +
    stat_summary(fun=mean,position=position_dodge(width=2.5),geom="bar", color = "black", alpha = 0.5, width = 2) +
  stat_summary(data = clusts_26_one, mapping = aes(x=day,y=frequency,fill=cluster_type), fun.data=mean_se,position=position_dodge(2.5),geom="errorbar",color = "black", width=2) +
    stat_summary(data = clusts_26_one, mapping = aes(x=day,y=frequency,fill=cluster_type), fun=mean,position=position_dodge(width=2.5),geom="bar", color = "black", width = 2) +
  theme_linedraw() + 
scale_fill_manual(values = c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                       "#F0E442", "#0072B2", "#D55E00", "#CC79A7","purple"), name = "Cluster size (cells)", labels = c("1","2","3","4","5","6-9","10-15","over 15","over 50")) + ylab("Mean # of clusters \n per image-stack") + scale_x_continuous(limits = c(0,21.9), breaks = c(0,2,6,9,13,16,20), minor_breaks = seq(0,21,1)) + xlab("") +
  scale_color_manual(values = c("black","purple"))+ theme(legend.position="bottom") + guides(fill = guide_legend(nrow=1, byrow=TRUE)) + coord_cartesian(xlim = c(0.5,20.5),ylim =c(-80,80)) + 
  scale_y_continuous(breaks=seq(-100,100,by=10),labels=abs(seq(-100,100,by=10))) +
  annotate("text", x = c(0), y = c(105), label="", hjust=0, vjust=0, fontface = "italic") + scale_alpha(guide=FALSE) + scale_color_manual(values = c("black","purple"), guide=FALSE) + 
      geom_vline(xintercept=c(7.5), linetype="dotted") +
  annotate("text", x = c(0), y = c(70), label='underline("26˚C")', parse = T, hjust=0, vjust=0) +
  annotate("text", x = c(0), y = c(-70), label='underline("32˚C")', parse = T, hjust=0, vjust=0) +
  geom_hline(yintercept=c(0)) +
  annotate("text", x = c(17), y = c(-70), label="B. minutum", hjust=0, vjust=0, fontface = "italic") +
  geom_signif(y_position = c(-83,-66), 
              xmin = c(8,8.32),
              xmax = c(8,8.32), size = 0, textsize = 2.5,
              annotation = c("NS"), tip_length = 0,color = "black") +
    geom_signif(y_position = c(53,75,70,68), 
              xmin = c(8.5,11.8,14.8,18.8),
              xmax = c(10.2,14.2,17.2,21.2), size = 0.5,
              annotation = c("***"), tip_length = 0.005,color = "black")

total_mf_plot_26_32
```
# Figure 3B


```{r}

df_mf_cluster_errors_26 <- subset(clusts_plus_long_one, Treatment == "26")
df_mf_cluster_errors_26 <- subset(df_mf_cluster_errors_26, cluster_type %in% c("hist_count"))

df_mf_cluster_errors_32 <- subset(clusts_plus_long_one, Treatment == "32")
df_mf_cluster_errors_32 <- subset(df_mf_cluster_errors_32, cluster_type %in% c("hist_count"))
df_mf_cluster_errors_32 <- subset(df_mf_cluster_errors_32, cluster_type %in% c("hist_count"))

df_mf_cluster_errors_26$cluster_type <- gsub("hist_count","Xone",df_mf_cluster_errors_26$cluster_type)
df_mf_cluster_errors_32$cluster_type <- gsub("hist_count","Xone",df_mf_cluster_errors_32$cluster_type)

```


```{r}

total_mf_plot_26_32_stack <- ggplot(clusts_32_one,aes(x=day,y=-frequency,fill=cluster_type)) +
    stat_summary(fun=mean,position="stack",geom="bar", color = "black", alpha = 0.5, width = 1.5) +
    stat_summary(data = clusts_26_one, mapping = aes(x=day,y=frequency,fill=cluster_type), fun=mean,position="stack",geom="bar", color = "black", width = 1.5) +
  theme_linedraw() + 
scale_fill_manual(values = c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                       "#F0E442", "#0072B2", "#D55E00", "#CC79A7","purple"), name = "Cluster size (cells)", labels = c("1","2","3","4","5","6-9","10-15","over 15","over 50")) +
  ylab("Total # of clusters \n per image-stack") +
  scale_x_continuous(limits = c(0,21.9), breaks = c(0,2,6,9,13,16,20), minor_breaks = seq(0,21,1)) +
  xlab("") +
  scale_color_manual(values = c("black","purple")) +
  theme(legend.position="bottom") +
  guides(fill = guide_legend(nrow=1, byrow=TRUE)) +
  coord_cartesian(ylim =c(-200,300)) + 
  scale_y_continuous(breaks=seq(-800,800,by=100),labels=abs(seq(-800,800,by=100))) +
  annotate("text", x = c(0), y = c(105), label="", hjust=0, vjust=0, fontface = "italic") +
  scale_alpha(guide=FALSE) +
  scale_color_manual(values = c("black","purple"), guide=FALSE) + 
      geom_vline(xintercept=c(7), linetype="dotted") +
  annotate("text", x = c(0), y = c(280), label='underline("26˚C")', parse = T, hjust=0, vjust=0) +
  annotate("text", x = c(0), y = c(-200), label='underline("32˚C")', parse = T, hjust=0, vjust=0) +
  geom_hline(yintercept=c(0)) +
  annotate("text", x = c(19), y = c(-200), label="B. minutum", hjust=0, vjust=0, fontface = "italic")


total_mf_plot_26_32_stack
```

```{r}
mf_stackclust_plot <-
total_mf_plot_26_32_stack + 
  stat_summary(data = df_mf_cluster_errors_32, inherit.aes = FALSE, mapping = aes(x=day,y=-frequency,fill = cluster_type), fun.data=mean_se, position= "identity", geom="errorbar", color = "black", width=1) +
  stat_summary(data = df_mf_cluster_errors_26, inherit.aes = FALSE, mapping = aes(x=day,y=frequency,fill = cluster_type), fun.data=mean_se,position= "identity",geom="errorbar",color = "black", width=1) +
    annotate("text", x = c(13), y = c(285), label="***") +
    annotate("text", x = c(16), y = c(260), label="***") +
    annotate("text", x = c(20), y = c(280), label="***") 


mf_stackclust_plot
```

# Figure 3C


```{r}

df_mf_cell_errors_26 <- subset(clusts_plus_long_one, Treatment == "26")
df_mf_cell_errors_26 <- subset(df_mf_cell_errors_26, cluster_type %in% c("hist_sum"))

df_mf_cell_errors_32 <- subset(clusts_plus_long_one, Treatment == "32")
df_mf_cell_errors_32 <- subset(df_mf_cell_errors_32, cluster_type %in% c("hist_sum"))

df_mf_cell_errors_26$cluster_type <- gsub("hist_sum","hist_sum_one",df_mf_cell_errors_26$cluster_type)
df_mf_cell_errors_32$cluster_type <- gsub("hist_sum","hist_sum_one",df_mf_cell_errors_32$cluster_type)

```

```{r}

total_mf_plot_26_32_stackhist15 <- ggplot(clusts_32_hist,aes(x=day,y=-frequency,fill=cluster_type)) + 
     stat_summary(fun=mean,position="stack",geom="bar", color = "black", alpha = 0.5, width = 1.5) +
    stat_summary(data = clusts_26_hist, mapping = aes(x=day,y=frequency,fill=cluster_type), fun=mean,position="stack",geom="bar", color = "black", width = 1.5) +
  theme_linedraw() + 
scale_fill_manual(values = c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                       "#F0E442", "#0072B2", "#D55E00", "#CC79A7","purple"), name = "Cluster size (cells)", labels = c("1","2","3","4","5","6-9","10-15","over 15","over 50")) + ylab("Total # of cells \n per image-stack") + scale_x_continuous(limits = c(0,21.9), breaks = c(0,2,6,9,13,16,20), minor_breaks = seq(0,21,1)) + xlab("") +
  scale_color_manual(values = c("black","purple"))+ theme(legend.position="bottom") + guides(fill = guide_legend(nrow=1, byrow=TRUE)) + coord_cartesian(ylim =c(-1500,2500)) + 
  scale_y_continuous(breaks=seq(-8000,8000,by=1000),labels=abs(seq(-8000,8000,by=1000))) +
  annotate("text", x = c(0), y = c(105), label="", hjust=0, vjust=0, fontface = "italic") + scale_alpha(guide=FALSE) + scale_color_manual(values = c("black","purple"), guide=FALSE) + 
      geom_vline(xintercept=c(7), linetype="dotted") +
  annotate("text", x = c(0), y = c(2300), label='underline("26˚C")', parse = T, hjust=0, vjust=0) +
  annotate("text", x = c(0), y = c(-1400), label='underline("32˚C")', parse = T, hjust=0, vjust=0) +
  geom_hline(yintercept=c(0)) +
  annotate("text", x = c(21), y = c(-1400), label="B. minutum", hjust=1, vjust=0, fontface = "italic")


total_mf_plot_26_32_stackhist15
```

```{r}
mf_stackhist_plot <- total_mf_plot_26_32_stackhist15 + 
  stat_summary(data = df_mf_cell_errors_32, inherit.aes = FALSE, mapping = aes(x=day,y=-frequency,fill = cluster_type), fun.data=mean_se, position= "identity", geom="errorbar", color = "black", width=1) +

 
  stat_summary(data = df_mf_cell_errors_26, inherit.aes = FALSE, mapping = aes(x=day,y=frequency,fill = cluster_type), fun.data=mean_se,position= "identity",geom="errorbar",color = "black", width=1) +
    annotate("text", x = c(9), y = c(1950), label="***") +
    annotate("text", x = c(13), y = c(2300), label="***") +
    annotate("text", x = c(16), y = c(2250), label="***") +
    annotate("text", x = c(20), y = c(2500), label="***") 
mf_stackhist_plot
```

# Final Figure 3

```{r} 
plot_mf_hists <-
ggarrange(total_mf_plot_26_32,
          mf_stackclust_plot,
          mf_stackhist_plot, labels = c("A","B","C"),
          nrow = 3, ncol = 1, common.legend = T, legend = "bottom")
plot_mf_hists
ggsave("plot_mf_hists.png", height = 10, width = 6)
```

